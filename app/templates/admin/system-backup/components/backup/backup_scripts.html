<script>
function updateRestoreWarning() {
    const restoreType = document.getElementById('restore_type').value;
    const warningBox = document.getElementById('warning_box');
    const warningList = document.getElementById('warning_list');
    const description = document.getElementById('restore_description');
    const submitBtn = document.getElementById('restore_submit_btn');
    const btnText = document.getElementById('restore_btn_text');
    
    if (restoreType === 'replace') {
        // Update warning for replace mode
        warningBox.className = 'bg-red-100 dark:bg-red-900/40 border border-red-300 dark:border-red-700 rounded-lg p-4 mb-4';
        warningList.innerHTML = `
            <li>• <strong>DESTRUCTIVE OPERATION:</strong> All existing data will be permanently deleted</li>
            <li>• You may be logged out if your user account is not in the backup</li>
            <li>• Current user sessions may be terminated</li>
            <li>• Always create a backup before proceeding</li>
            <li>• This action cannot be undone</li>
        `;
        description.innerHTML = '<strong class="text-red-600 dark:text-red-400">Replace mode will DELETE ALL existing data and replace it with backup data. You may need to log in again.</strong>';
        btnText.textContent = 'REPLACE ALL DATA (DESTRUCTIVE)';
        submitBtn.className = 'w-full bg-red-700 text-white py-2 px-4 rounded-lg hover:bg-red-800 transition-colors';
    }
    // Don't change styles for merge mode - keep the default HTML styles to prevent flickering
}

// Enhanced form submission with specific confirmation messages
document.addEventListener('DOMContentLoaded', function() {
    const restoreForm = document.querySelector('form[action*="restore_backup"]');
    if (restoreForm) {
        restoreForm.addEventListener('submit', function(e) {
            const restoreType = document.getElementById('restore_type').value;
            const fileName = document.querySelector('input[name="backup_file"]').files[0]?.name || 'selected backup';
            
            let confirmMessage;
            if (restoreType === 'replace') {
                confirmMessage = `⚠️ DESTRUCTIVE OPERATION WARNING ⚠️\n\n` +
                                `You are about to PERMANENTLY DELETE all existing data and replace it with: ${fileName}\n\n` +
                                `This will:\n` +
                                `• Delete ALL users, login attempts, contacts, and verifications\n` +
                                `• You may be logged out and need to log in again\n` +
                                `• Terminate current user sessions\n` +
                                `• Cannot be undone\n\n` +
                                `Are you absolutely sure you want to proceed?`;
            } else {
                confirmMessage = `Confirm Backup Restore\n\n` +
                                `You are about to restore data from: ${fileName}\n\n` +
                                `This will merge backup data with existing data:\n` +
                                `• Update existing records with backup versions\n` +
                                `• Add new records from backup\n` +
                                `• Preserve existing data not in backup\n\n` +
                                `Continue with restore?`;
            }
            
            if (!confirm(confirmMessage)) {
                e.preventDefault();
            }
        });
    }
    
    // Add event listeners for restore buttons
    document.querySelectorAll('.restore-backup-btn').forEach(button => {
        button.addEventListener('click', function() {
            const filename = this.dataset.filename;
            const records = this.dataset.records;
            const created = this.dataset.created;
            showRestoreModal(filename, records, created);
        });
    });
});

function showRestoreModal(filename, records, created) {
    const modal = document.getElementById('restoreModal');
    const modalDescription = document.getElementById('modalDescription');
    const modalBackupFilename = document.getElementById('modalBackupFilename');
    
    // Set the hidden form field
    modalBackupFilename.value = filename;
    
    // Update modal content with better formatting
    modalDescription.innerHTML = `
        <div class="space-y-2">
            <div class="flex justify-between">
                <span class="font-medium text-gray-700 dark:text-gray-300">Backup File:</span>
                <span class="text-gray-900 dark:text-white font-mono text-sm">${filename}</span>
            </div>
            <div class="flex justify-between">
                <span class="font-medium text-gray-700 dark:text-gray-300">Created:</span>
                <span class="text-gray-900 dark:text-white">${created}</span>
            </div>
            <div class="flex justify-between">
                <span class="font-medium text-gray-700 dark:text-gray-300">Records:</span>
                <span class="text-gray-900 dark:text-white">${records !== 'Error' && records !== 'Unknown' ? records + ' records' : 'Unknown'}</span>
            </div>
        </div>
        <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-600">
            <p class="text-sm text-gray-600 dark:text-gray-400">
                Choose how to restore this backup to your database:
            </p>
        </div>
    `;
    
    // Reset to merge mode
    document.getElementById('modalRestoreType').value = 'merge';
    updateModalWarning();
    
    // Show modal
    modal.classList.remove('hidden');
}

function closeRestoreModal() {
    const modal = document.getElementById('restoreModal');
    modal.classList.add('hidden');
}

function updateModalWarning() {
    const restoreType = document.getElementById('modalRestoreType').value;
    const warningBox = document.getElementById('modalWarningBox');
    const warningList = document.getElementById('modalWarningList');
    const restoreBtn = document.getElementById('modalRestoreBtn');
    
    if (restoreType === 'replace') {
        // Update warning for replace mode
        warningBox.className = 'mb-6 p-4 rounded-lg border bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800';
        warningList.innerHTML = `
            <li>• <strong>DESTRUCTIVE:</strong> All existing data will be deleted</li>
            <li>• You may be logged out during restore</li>
            <li>• This action cannot be undone</li>
        `;
        restoreBtn.textContent = 'REPLACE ALL DATA (DESTRUCTIVE)';
        restoreBtn.className = 'flex-1 px-4 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors cursor-pointer';
        
        // Update icon color for danger
        const icon = warningBox.querySelector('i');
        if (icon) {
            icon.className = 'bi bi-exclamation-triangle text-red-600 dark:text-red-400 text-lg mt-0.5 mr-3 flex-shrink-0';
        }
    } else {
        // Update warning for merge mode
        warningBox.className = 'mb-6 p-4 rounded-lg border bg-yellow-50 dark:bg-yellow-900/20 border-yellow-200 dark:border-yellow-800';
        warningList.innerHTML = `
            <li>• Always create a backup before restoring</li>
            <li>• Existing data will be preserved and updated</li>
            <li>• This action cannot be undone</li>
        `;
        restoreBtn.textContent = 'Restore Backup';
        restoreBtn.className = 'flex-1 px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors cursor-pointer';
        
        // Update icon color for warning
        const icon = warningBox.querySelector('i');
        if (icon) {
            icon.className = 'bi bi-exclamation-triangle text-yellow-600 dark:text-yellow-400 text-lg mt-0.5 mr-3 flex-shrink-0';
        }
    }
}

// Enhanced form submission with confirmation for direct restore
document.addEventListener('DOMContentLoaded', function() {
    const directRestoreForm = document.getElementById('directRestoreForm');
    if (directRestoreForm) {
        directRestoreForm.addEventListener('submit', function(e) {
            const restoreType = document.getElementById('modalRestoreType').value;
            const filename = document.getElementById('modalBackupFilename').value;
            
            let confirmMessage;
            if (restoreType === 'replace') {
                confirmMessage = `⚠️ DESTRUCTIVE OPERATION WARNING ⚠️\n\n` +
                                `You are about to PERMANENTLY DELETE all existing data and replace it with:\n${filename}\n\n` +
                                `This will:\n` +
                                `• Delete ALL current data in the database\n` +
                                `• You may be logged out and need to log in again\n` +
                                `• Cannot be undone\n\n` +
                                `Are you absolutely sure you want to proceed?`;
            } else {
                confirmMessage = `Confirm Server Restore\n\n` +
                                `You are about to restore data from server backup:\n${filename}\n\n` +
                                `This will merge backup data with existing data:\n` +
                                `• Update existing records with backup versions\n` +
                                `• Add new records from backup\n` +
                                `• Preserve existing data not in backup\n\n` +
                                `Continue with restore?`;
            }
            
            if (!confirm(confirmMessage)) {
                e.preventDefault();
            }
        });
    }
});
</script>