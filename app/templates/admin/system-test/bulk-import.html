{% extends "base.html" %}

{% block title %}Bulk Import Test Plans{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Page Header -->
        <div class="flex justify-between items-center mb-8 opacity-0 animate-fade-in-up">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Bulk Import Test Plans</h1>
                <p class="text-gray-600 dark:text-gray-400 mt-2">Import multiple test plans from JSON data</p>
            </div>
            <div>
                <a href="{{ url_for('system_test.test_plans_list') }}" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 flex items-center">
                    <i class="bi bi-arrow-left mr-2"></i> Back to List
                </a>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2">
                <!-- Import Form -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border-l-4 border-blue-500 mb-8">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-blue-600 dark:text-blue-400 flex items-center">
                            <i class="bi bi-upload mr-2"></i> Import JSON Data
                        </h3>
                    </div>
                    <div class="p-6">
                        <form method="POST" id="importForm">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <div class="space-y-4">
                                <div>
                                    <label for="import_data" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">JSON Data <span class="text-red-500">*</span></label>
                                    <textarea id="import_data" 
                                              name="import_data" 
                                              rows="20" 
                                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-900 text-gray-900 dark:text-white font-mono text-sm"
                                              placeholder="Paste your JSON data here..."
                                              required></textarea>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Paste JSON array of test plan objects</p>
                                </div>
                                
                                <div class="flex space-x-4">
                                    <button type="button" 
                                            onclick="validateJson()" 
                                            class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 flex items-center">
                                        <i class="bi bi-check-circle mr-2"></i> Validate JSON
                                    </button>
                                    <button type="button" 
                                            onclick="loadExample()" 
                                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 flex items-center">
                                        <i class="bi bi-file-text mr-2"></i> Load Example
                                    </button>
                                    <button type="submit" 
                                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 flex items-center">
                                        <i class="bi bi-upload mr-2"></i> Import Test Plans
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Validation Results -->
                <div id="validationResults" class="hidden rounded-lg p-4 mb-6"></div>
            </div>

            <div class="space-y-8">
                <!-- Instructions -->
                <div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-200 dark:border-blue-700">
                    <div class="p-4 bg-blue-100 dark:bg-blue-800/30 rounded-t-xl border-b border-blue-200 dark:border-blue-700">
                        <h4 class="text-sm font-medium text-blue-800 dark:text-blue-200 flex items-center">
                            <i class="bi bi-info-circle mr-2"></i> Instructions
                        </h4>
                    </div>
                    <div class="p-4">
                        <ul class="text-sm text-blue-700 dark:text-blue-300 space-y-2">
                            <li class="flex items-start">
                                <i class="bi bi-check2 mr-2 mt-0.5 text-blue-600"></i>
                                Format data as JSON array
                            </li>
                            <li class="flex items-start">
                                <i class="bi bi-check2 mr-2 mt-0.5 text-blue-600"></i>
                                Include required fields: test_plan_no, module_name, description, expected_results, procedure
                            </li>
                            <li class="flex items-start">
                                <i class="bi bi-check2 mr-2 mt-0.5 text-blue-600"></i>
                                Use \\n for line breaks in procedure steps
                            </li>
                            <li class="flex items-start">
                                <i class="bi bi-check2 mr-2 mt-0.5 text-blue-600"></i>
                                Validate JSON before importing
                            </li>
                            <li class="flex items-start">
                                <i class="bi bi-check2 mr-2 mt-0.5 text-blue-600"></i>
                                Ensure unique test_plan_no values
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Example JSON -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg">
                    <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                        <h4 class="text-sm font-medium text-gray-900 dark:text-white">Example JSON Format</h4>
                    </div>
                    <div class="p-4">
                        <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto">
                            <pre class="text-sm text-green-400 whitespace-pre-wrap"><code>[
  {
    "test_plan_no": "STP-001-01",
    "module_name": "Home Page",
    "screen_design_ref": "Figure 2.1: Home Page",
    "description": "Verify home page loads correctly",
    "scenario": "User navigates to home page",
    "expected_results": "Home page displays all sections",
    "procedure": "1. Open browser\n2. Navigate to URL\n3. Verify page loads\n4. Check all sections visible",
    "test_status": "pending",
    "priority": "high",
    "category": "functional"
  },
  {
    "test_plan_no": "STP-001-02",
    "module_name": "Home Page",
    "description": "Test navigation functionality",
    "expected_results": "Navigation works correctly",
    "procedure": "1. Click navigation links\n2. Verify redirection\n3. Check page content",
    "priority": "medium",
    "category": "functional"
  }
]</code></pre>
                        </div>
                    </div>
                </div>

                <!-- Field Reference -->
                <div class="bg-yellow-50 dark:bg-yellow-900/20 rounded-xl border border-yellow-200 dark:border-yellow-700">
                    <div class="p-4 border-b border-yellow-200 dark:border-yellow-700">
                        <h4 class="text-sm font-medium text-yellow-800 dark:text-yellow-200">Field Reference</h4>
                    </div>
                    <div class="p-4">
                        <div class="text-xs text-yellow-700 dark:text-yellow-300 space-y-2">
                            <p><strong>Required:</strong> test_plan_no, module_name, description, expected_results, procedure</p>
                            <p><strong>Optional:</strong> screen_design_ref, scenario, test_status, priority, category</p>
                            <p><strong>Status:</strong> pending, passed, failed, skipped</p>
                            <p><strong>Priority:</strong> low, medium, high, critical</p>
                            <p><strong>Category:</strong> functional, ui, performance, security, integration</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function validateJson() {
    const textarea = document.getElementById('import_data');
    const resultsDiv = document.getElementById('validationResults');
    
    try {
        const data = JSON.parse(textarea.value);
        
        if (!Array.isArray(data)) {
            throw new Error('Data must be a JSON array');
        }
        
        if (data.length === 0) {
            throw new Error('Array cannot be empty');
        }
        
        // Validate each test plan object
        const requiredFields = ['test_plan_no', 'module_name', 'description', 'expected_results', 'procedure'];
        const errors = [];
        
        data.forEach((item, index) => {
            requiredFields.forEach(field => {
                if (!item[field] || !item[field].toString().trim()) {
                    errors.push(`Item ${index + 1}: Missing required field '${field}'`);
                }
            });
            
            // Validate test_plan_no uniqueness
            const duplicates = data.filter(d => d.test_plan_no === item.test_plan_no);
            if (duplicates.length > 1) {
                errors.push(`Item ${index + 1}: Duplicate test_plan_no '${item.test_plan_no}'`);
            }
            
            // Validate enum fields
            if (item.test_status && !['pending', 'passed', 'failed', 'skipped'].includes(item.test_status)) {
                errors.push(`Item ${index + 1}: Invalid test_status '${item.test_status}'`);
            }
            
            if (item.priority && !['low', 'medium', 'high', 'critical'].includes(item.priority)) {
                errors.push(`Item ${index + 1}: Invalid priority '${item.priority}'`);
            }
            
            if (item.category && !['functional', 'ui', 'performance', 'security', 'integration'].includes(item.category)) {
                errors.push(`Item ${index + 1}: Invalid category '${item.category}'`);
            }
        });
        
        if (errors.length > 0) {
            resultsDiv.className = 'bg-red-50 border border-red-200 text-red-700 dark:bg-red-900/20 dark:border-red-700 dark:text-red-300 rounded-lg p-4 mb-6';
            resultsDiv.innerHTML = `
                <h4 class="font-medium flex items-center mb-2"><i class="bi bi-x-circle mr-2"></i> Validation Errors:</h4>
                <ul class="list-disc list-inside space-y-1">
                    ${errors.map(error => `<li class="text-sm">${error}</li>`).join('')}
                </ul>
            `;
        } else {
            resultsDiv.className = 'bg-green-50 border border-green-200 text-green-700 dark:bg-green-900/20 dark:border-green-700 dark:text-green-300 rounded-lg p-4 mb-6';
            resultsDiv.innerHTML = `
                <p class="flex items-center"><i class="bi bi-check-circle mr-2"></i> Found ${data.length} valid test plan(s) ready for import.</p>
            `;
        }
        
        resultsDiv.classList.remove('hidden');
        
    } catch (error) {
        resultsDiv.className = 'bg-red-50 border border-red-200 text-red-700 dark:bg-red-900/20 dark:border-red-700 dark:text-red-300 rounded-lg p-4 mb-6';
        resultsDiv.innerHTML = `
            <h4 class="font-medium flex items-center mb-2"><i class="bi bi-x-circle mr-2"></i> JSON Parse Error:</h4>
            <p class="text-sm">${error.message}</p>
        `;
        resultsDiv.classList.remove('hidden');
    }
}

function loadExample() {
    const exampleData = [
        {
            "test_plan_no": "STP-001-01",
            "module_name": "Home Page",
            "screen_design_ref": "Figure 2.1: Home Page",
            "description": "Verify that the home page loads correctly when accessing the root URL",
            "scenario": "User navigates to the home page by typing the URL",
            "expected_results": "Display the complete home page with hero section, features, learning modules, and CTA sections",
            "procedure": "1. Open web browser\n2. Navigate to http://localhost:5000/\n3. Verify page loads completely\n4. Check all sections are visible (Hero, Features, Learning Modules, CTA)",
            "test_status": "pending",
            "priority": "high",
            "category": "functional"
        },
        {
            "test_plan_no": "STP-001-02",
            "module_name": "Home Page", 
            "screen_design_ref": "Figure 2.2: Home Page CTA - Authenticated",
            "description": "Verify authenticated user can navigate to levels overview from home page",
            "scenario": "Authenticated user clicks on learning buttons",
            "expected_results": "User is redirected to levels overview page when clicking Start Learning or Continue Learning",
            "procedure": "1. Login as authenticated user\n2. Navigate to home page\n3. Click 'Start Learning' or 'Continue Learning' button\n4. Verify redirection to levels overview",
            "test_status": "pending",
            "priority": "high",
            "category": "functional"
        }
    ];
    
    document.getElementById('import_data').value = JSON.stringify(exampleData, null, 2);
    
    // Auto-validate after loading example
    setTimeout(validateJson, 100);
}

// Form validation before submission
document.getElementById('importForm').addEventListener('submit', function(e) {
    const textarea = document.getElementById('import_data');
    
    if (!textarea.value.trim()) {
        e.preventDefault();
        alert('Please provide JSON data to import.');
        return;
    }
    
    try {
        const data = JSON.parse(textarea.value);
        if (!Array.isArray(data) || data.length === 0) {
            e.preventDefault();
            alert('Please provide a valid JSON array with test plan data.');
            return;
        }
        
        if (!confirm(`Are you sure you want to import ${data.length} test plan(s)?`)) {
            e.preventDefault();
            return;
        }
        
    } catch (error) {
        e.preventDefault();
        alert('Invalid JSON format. Please validate your data first.');
        return;
    }
});

// Auto-format JSON on paste
document.getElementById('import_data').addEventListener('paste', function() {
    setTimeout(() => {
        try {
            const data = JSON.parse(this.value);
            this.value = JSON.stringify(data, null, 2);
        } catch (e) {
            // Ignore parsing errors for partial pastes
        }
    }, 100);
});
</script>
{% endblock %}
