{% extends "admin/base.html" %}

{% block title %}Execute Test Plan{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
<style>
.test-execution-card {
    border-left: 4px solid #007bff;
}

.procedure-step {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.5rem;
    border-left: 3px solid #28a745;
}

.execution-result {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    padding: 1.5rem;
    margin-top: 1rem;
}

.status-button {
    min-width: 120px;
    margin: 0.25rem;
}

.timer {
    font-family: 'Courier New', monospace;
    font-size: 1.2rem;
    font-weight: bold;
}
</style>
{% endblock %}

{% block admin_content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">Execute Test Plan</h1>
            <p class="text-muted">{{ test_plan.test_plan_no }} - {{ test_plan.module_name }}</p>
        </div>
        <div>
            <a href="{{ url_for('system_test.view_test_plan', test_plan_id=test_plan.id) }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Test Plan
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Test Information -->
            <div class="card shadow mb-4 test-execution-card">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-clipboard-check"></i> Test Information
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Test Plan No:</strong> {{ test_plan.test_plan_no }}
                        </div>
                        <div class="col-md-6">
                            <strong>Module:</strong> {{ test_plan.module_name }}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Priority:</strong> 
                            <span class="badge bg-{{ 'danger' if test_plan.priority == 'critical' 
                                                   else 'warning' if test_plan.priority == 'high'
                                                   else 'info' if test_plan.priority == 'medium'
                                                   else 'success' }}">
                                {{ test_plan.priority or 'medium' }}
                            </span>
                        </div>
                        <div class="col-md-6">
                            <strong>Category:</strong> 
                            <span class="badge bg-secondary">{{ test_plan.category or 'functional' }}</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <strong>Description:</strong>
                        <p class="mt-2">{{ test_plan.description }}</p>
                    </div>
                    {% if test_plan.scenario %}
                    <div class="mb-3">
                        <strong>Scenario:</strong>
                        <p class="mt-2">{{ test_plan.scenario }}</p>
                    </div>
                    {% endif %}
                    <div class="mb-3">
                        <strong>Expected Results:</strong>
                        <p class="mt-2">{{ test_plan.expected_results }}</p>
                    </div>
                </div>
            </div>

            <!-- Test Procedure -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-list-ol"></i> Test Procedure
                    </h6>
                    <div class="timer" id="executionTimer">
                        <i class="bi bi-stopwatch"></i> 00:00:00
                    </div>
                </div>
                <div class="card-body">
                    <div id="procedureSteps">
                        {% set procedure_steps = test_plan.procedure.split('\n') %}
                        {% for step in procedure_steps %}
                        {% if step.strip() %}
                        <div class="procedure-step" data-step="{{ loop.index }}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    {{ step.strip() }}
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input step-checkbox" type="checkbox" 
                                           id="step{{ loop.index }}" data-step="{{ loop.index }}">
                                    <label class="form-check-label" for="step{{ loop.index }}">
                                        <i class="bi bi-check-circle text-success" style="display: none;"></i>
                                    </label>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Execution Controls -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-success">
                        <i class="bi bi-play-circle"></i> Execution Controls
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2 mb-3">
                        <button type="button" class="btn btn-success" id="startTest">
                            <i class="bi bi-play"></i> Start Test Execution
                        </button>
                        <button type="button" class="btn btn-warning" id="pauseTest" disabled>
                            <i class="bi bi-pause"></i> Pause
                        </button>
                        <button type="button" class="btn btn-secondary" id="resetTest">
                            <i class="bi bi-arrow-counterclockwise"></i> Reset
                        </button>
                    </div>

                    <div class="progress mb-3">
                        <div class="progress-bar" role="progressbar" style="width: 0%" id="progressBar">
                            0%
                        </div>
                    </div>

                    <div class="text-center">
                        <small class="text-muted">
                            <span id="completedSteps">0</span> of <span id="totalSteps">{{ procedure_steps|length }}</span> steps completed
                        </small>
                    </div>
                </div>
            </div>

            <!-- Test Result -->
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-clipboard-data"></i> Test Result
                    </h6>
                </div>
                <div class="card-body">
                    <form method="POST" id="resultForm">
                        <div class="mb-3">
                            <label for="test_status" class="form-label">Test Status <span class="text-danger">*</span></label>
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-success status-button" 
                                        onclick="setStatus('passed')" id="passBtn">
                                    <i class="bi bi-check-circle"></i> PASSED
                                </button>
                                <button type="button" class="btn btn-danger status-button" 
                                        onclick="setStatus('failed')" id="failBtn">
                                    <i class="bi bi-x-circle"></i> FAILED
                                </button>
                                <button type="button" class="btn btn-warning status-button" 
                                        onclick="setStatus('skipped')" id="skipBtn">
                                    <i class="bi bi-skip-forward-circle"></i> SKIPPED
                                </button>
                            </div>
                            <input type="hidden" name="test_status" id="test_status" required>
                        </div>

                        <div class="mb-3" id="failureReasonDiv" style="display: none;">
                            <label for="failure_reason" class="form-label">Failure Reason <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="failure_reason" name="failure_reason" rows="4" 
                                      placeholder="Describe why the test failed..."></textarea>
                            <div class="form-text">Provide detailed information about the failure for debugging.</div>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary" id="submitResult" disabled>
                                <i class="bi bi-save"></i> Save Test Result
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let testStartTime = null;
let testTimer = null;
let isPaused = false;
let totalSteps = {{ procedure_steps|length }};

// Timer functions
function startTimer() {
    testStartTime = new Date();
    testTimer = setInterval(updateTimer, 1000);
}

function pauseTimer() {
    if (testTimer) {
        clearInterval(testTimer);
        testTimer = null;
    }
}

function resetTimer() {
    pauseTimer();
    testStartTime = null;
    document.getElementById('executionTimer').innerHTML = '<i class="bi bi-stopwatch"></i> 00:00:00';
}

function updateTimer() {
    if (!testStartTime) return;
    
    const now = new Date();
    const elapsed = Math.floor((now - testStartTime) / 1000);
    
    const hours = Math.floor(elapsed / 3600);
    const minutes = Math.floor((elapsed % 3600) / 60);
    const seconds = elapsed % 60;
    
    const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    document.getElementById('executionTimer').innerHTML = `<i class="bi bi-stopwatch"></i> ${timeString}`;
}

// Progress tracking
function updateProgress() {
    const checkedSteps = document.querySelectorAll('.step-checkbox:checked').length;
    const progressPercent = (checkedSteps / totalSteps) * 100;
    
    document.getElementById('progressBar').style.width = progressPercent + '%';
    document.getElementById('progressBar').textContent = Math.round(progressPercent) + '%';
    document.getElementById('completedSteps').textContent = checkedSteps;
    
    // Update progress bar color
    const progressBar = document.getElementById('progressBar');
    if (progressPercent === 100) {
        progressBar.className = 'progress-bar bg-success';
    } else if (progressPercent >= 50) {
        progressBar.className = 'progress-bar bg-warning';
    } else {
        progressBar.className = 'progress-bar';
    }
}

// Test status functions
function setStatus(status) {
    document.getElementById('test_status').value = status;
    
    // Update button states
    document.querySelectorAll('.status-button').forEach(btn => {
        btn.classList.remove('active');
    });
    document.getElementById(status === 'passed' ? 'passBtn' : 
                          status === 'failed' ? 'failBtn' : 'skipBtn').classList.add('active');
    
    // Show/hide failure reason
    const failureDiv = document.getElementById('failureReasonDiv');
    const failureTextarea = document.getElementById('failure_reason');
    
    if (status === 'failed') {
        failureDiv.style.display = 'block';
        failureTextarea.required = true;
    } else {
        failureDiv.style.display = 'none';
        failureTextarea.required = false;
        failureTextarea.value = '';
    }
    
    // Enable submit button
    document.getElementById('submitResult').disabled = false;
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Initialize total steps counter
    document.getElementById('totalSteps').textContent = totalSteps;
    
    // Start test button
    document.getElementById('startTest').addEventListener('click', function() {
        startTimer();
        this.disabled = true;
        document.getElementById('pauseTest').disabled = false;
    });
    
    // Pause test button
    document.getElementById('pauseTest').addEventListener('click', function() {
        if (isPaused) {
            startTimer();
            this.textContent = 'Pause';
            this.className = 'btn btn-warning';
            isPaused = false;
        } else {
            pauseTimer();
            this.innerHTML = '<i class="bi bi-play"></i> Resume';
            this.className = 'btn btn-success';
            isPaused = true;
        }
    });
    
    // Reset test button
    document.getElementById('resetTest').addEventListener('click', function() {
        if (confirm('Are you sure you want to reset the test execution?')) {
            resetTimer();
            document.getElementById('startTest').disabled = false;
            document.getElementById('pauseTest').disabled = true;
            isPaused = false;
            
            // Uncheck all steps
            document.querySelectorAll('.step-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateProgress();
        }
    });
    
    // Step checkboxes
    document.querySelectorAll('.step-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateProgress();
            
            // Visual feedback
            const stepDiv = this.closest('.procedure-step');
            const icon = this.nextElementSibling.querySelector('i');
            
            if (this.checked) {
                stepDiv.style.borderLeftColor = '#28a745';
                stepDiv.style.backgroundColor = '#d4edda';
                icon.style.display = 'inline';
            } else {
                stepDiv.style.borderLeftColor = '#28a745';
                stepDiv.style.backgroundColor = '#f8f9fa';
                icon.style.display = 'none';
            }
        });
    });
    
    // Form submission
    document.getElementById('resultForm').addEventListener('submit', function(e) {
        const status = document.getElementById('test_status').value;
        if (!status) {
            e.preventDefault();
            alert('Please select a test status.');
            return;
        }
        
        if (status === 'failed' && !document.getElementById('failure_reason').value.trim()) {
            e.preventDefault();
            alert('Please provide a failure reason for failed tests.');
            return;
        }
        
        // Stop timer
        pauseTimer();
        
        // Confirm submission
        if (!confirm(`Are you sure you want to mark this test as ${status.toUpperCase()}?`)) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}
