/**
 * Event Handler Module for Vulnerability Scanner
 * Handles all event binding and event management
 */
export class VulnerabilityScannerEventHandler {
    constructor(uiRenderer, scannerLogic, dataManager, tabManager, notificationManager) {
        this.uiRenderer = uiRenderer;
        this.scannerLogic = scannerLogic;
        this.dataManager = dataManager;
        this.tabManager = tabManager;
        this.notificationManager = notificationManager;
    }

    bindEvents() {
        this.bindScanTypeEvents();
        this.bindTargetEvents();
        this.bindScanControlEvents();
        this.bindTabEvents();
    }

    bindScanTypeEvents() {
        // Scan type change handler
        this.uiRenderer.elements.scanTypeSelect.addEventListener('change', (e) => {
            if (e.target.value === 'custom') {
                this.uiRenderer.elements.customScanOptions.classList.remove('hidden');
            } else {
                this.uiRenderer.elements.customScanOptions.classList.add('hidden');
            }
        });
    }

    bindTargetEvents() {
        // Add target button
        this.uiRenderer.elements.addTargetBtn.addEventListener('click', () => {
            this.handleAddTarget();
        });

        // Target selection change
        this.uiRenderer.elements.targetSelect.addEventListener('change', (e) => {
            if (e.target.value) {
                this.handleTargetSelection(e.target.value);
            }
        });

        // Allow adding target with Enter key
        this.uiRenderer.elements.targetUrlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                this.handleAddTarget();
            }
        });
    }

    bindScanControlEvents() {
        // Toggle scan button
        this.uiRenderer.elements.scanToggleBtn.addEventListener('click', () => {
            if (this.scannerLogic.isScanning) {
                this.scannerLogic.stopScan();
            } else {
                this.scannerLogic.startScan();
            }
        });

        // Export results button
        this.uiRenderer.elements.exportResultsBtn.addEventListener('click', () => {
            this.scannerLogic.exportResults();
        });
    }

    bindTabEvents() {
        // Delegate tab events to tab manager
        this.tabManager.bindTabEvents();
    }

    handleAddTarget() {
        const url = this.uiRenderer.elements.targetUrlInput.value.trim();
        if (!url) {
            this.notificationManager.show('Please enter a target URL', 'error');
            return;
        }

        // Basic URL validation
        try {
            new URL(url);
        } catch {
            this.notificationManager.show('Please enter a valid URL', 'error');
            return;
        }

        // Extract domain for name
        const domain = new URL(url).hostname;
        const targetData = {
            id: `custom-${Date.now()}`,
            name: `Custom Target - ${domain}`,
            url: url,
            description: `Custom target added by user`,
            type: 'web_application',
            technology: 'Unknown',
            criticality: 'Medium',
            status: 'Active',
            lastScanned: null,
            vulnerabilities: [],
            endpoints: ['/'],
            forms: []
        };

        const success = this.dataManager.addTarget(targetData);
        if (success) {
            this.dataManager.populateTargetList();
            this.dataManager.updateStatistics();
            this.uiRenderer.elements.targetUrlInput.value = '';
            this.notificationManager.show(`Target ${domain} added successfully`, 'success');
        } else {
            this.notificationManager.show('Failed to add target', 'error');
        }
    }

    handleTargetSelection(targetId) {
        const target = this.dataManager.selectTarget(targetId);
        if (target) {
            this.notificationManager.show(`Selected target: ${target.name}`, 'info');
        } else {
            this.notificationManager.show('Target not found', 'error');
        }
    }

    // Keyboard shortcuts
    bindKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            // Only handle shortcuts when the scanner is focused
            if (!this.isInFocus()) return;

            // Ctrl+Enter to start/stop scan
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                if (this.scannerLogic.isScanning) {
                    this.scannerLogic.stopScan();
                } else {
                    this.scannerLogic.startScan();
                }
            }

            // Ctrl+E to export results
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                this.scannerLogic.exportResults();
            }

            // Tab navigation (1-4 keys)
            if (e.key >= '1' && e.key <= '4') {
                e.preventDefault();
                const tabMap = {
                    '1': 'vulnerabilities',
                    '2': 'requests',
                    '3': 'evidence',
                    '4': 'targets'
                };
                this.tabManager.switchToTab(tabMap[e.key]);
            }
        });
    }

    isInFocus() {
        // Check if the vulnerability scanner container or any of its children have focus
        const container = document.querySelector('#vulnerability-scanner-container');
        return container && (container.contains(document.activeElement) || document.activeElement === container);
    }

    // Cleanup event listeners
    destroy() {
        // Remove any global event listeners if needed
        // Currently no global listeners to remove as they're all bound to elements
    }
}
