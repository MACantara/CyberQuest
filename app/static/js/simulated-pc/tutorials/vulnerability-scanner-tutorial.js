import { BaseTutorial } from './base-tutorial.js';
import { tutorialInteractionManager } from './tutorial-interaction-manager.js';

export class VulnerabilityScannerTutorial extends BaseTutorial {
    constructor(desktop) {
        super(desktop);
        this.steps = [
            {
                target: '#vulnerability-scanner-container',
                title: 'Web Vulnerability Scanner',
                content: 'Welcome to the Web Vulnerability Scanner! This powerful cybersecurity tool helps identify security weaknesses in web applications and systems. You\'ll learn to scan targets, analyze vulnerabilities, and generate professional security reports.',
                action: 'highlight',
                position: 'bottom'
            },
            {
                target: '#target-selection',
                title: 'Target Selection Panel',
                content: 'This is where you select or define targets for vulnerability scanning. You can choose from predefined targets or add custom URLs. Always ensure you have proper authorization before scanning any target.',
                action: 'highlight',
                position: 'right'
            },
            {
                target: '#targetSelect',
                title: 'Interactive: Select a Target',
                content: 'Choose a target from the dropdown menu. For this tutorial, select the "Municipal Voting Portal" target to begin your first vulnerability scan.',
                action: 'pulse',
                position: 'right',
                interactive: true,
                interaction: {
                    type: 'select',
                    expectedValue: 'municipality-voting-portal',
                    instructions: 'Select "Municipal Voting Portal" from the dropdown',
                    successMessage: 'Great! You\'ve selected the municipal voting portal as your scan target.',
                    autoAdvance: true,
                    advanceDelay: 2000
                }
            },
            {
                target: '#scanTypeSelect',
                title: 'Scan Configuration',
                content: 'Choose your scan type based on your needs. "Comprehensive Scan" tests for all vulnerability types, "Quick Scan" focuses on common issues, and "Custom Scan" lets you select specific tests.',
                action: 'highlight',
                position: 'right'
            },
            {
                target: '#customScanOptions',
                title: 'Custom Scan Options',
                content: 'When using custom scans, you can select specific vulnerability tests like SQL Injection, Cross-Site Scripting (XSS), Directory Traversal, and more. Each test targets different types of security weaknesses.',
                action: 'highlight',
                position: 'right'
            },
            {
                target: '#scanToggleBtn',
                title: 'Interactive: Start Your First Scan',
                content: 'Click the "Start Vulnerability Scan" button to begin scanning the selected target. The scanner will systematically test for various security vulnerabilities.',
                action: 'pulse',
                position: 'left',
                interactive: true,
                interaction: {
                    type: 'click',
                    instructions: 'Click "Start Vulnerability Scan" to begin',
                    successMessage: 'Excellent! The vulnerability scan has started.',
                    autoAdvance: true,
                    advanceDelay: 3000
                }
            },
            {
                target: '#progressBar',
                title: 'Scan Progress Monitoring',
                content: 'Watch the progress bar to monitor your scan\'s advancement. The scanner tests different endpoints and attack vectors systematically. You can see the current test being performed below the progress bar.',
                action: 'highlight',
                position: 'right'
            },
            {
                target: '.stats-panel',
                title: 'Real-time Statistics',
                content: 'These statistics provide a real-time overview of your scan results: total targets scanned, vulnerable targets found, total vulnerabilities discovered, and high/critical severity issues. This helps you quickly assess the security posture.',
                action: 'highlight',
                position: 'bottom'
            },
            {
                target: '.tab-navigation',
                title: 'Results Organization',
                content: 'Scan results are organized into tabs: Vulnerabilities shows security issues found, HTTP Requests displays all requests made during scanning, and Evidence contains proof-of-concept data for each vulnerability.',
                action: 'highlight',
                position: 'bottom'
            },
            {
                target: '#vulnerabilitiesTab',
                title: 'Vulnerability Results',
                content: 'The main results area displays all vulnerabilities discovered during the scan. Each vulnerability includes severity level, description, affected URL, and technical details to help you understand and fix the issue.',
                action: 'highlight',
                position: 'left'
            },
            {
                target: '#vulnerabilitiesContainer',
                title: 'Vulnerability Details',
                content: 'Each vulnerability entry shows critical information: severity level (color-coded), vulnerability type, affected endpoint, and detailed technical information. Click on any vulnerability to see expanded details and remediation advice.',
                action: 'highlight',
                position: 'left'
            },
            {
                target: '#generateHTMLReportBtn',
                title: 'Professional Reporting',
                content: 'Generate comprehensive vulnerability reports in multiple formats. HTML reports provide detailed analysis perfect for presentations, while CSV summaries offer data for spreadsheet analysis.',
                action: 'highlight',
                position: 'left'
            },
            {
                target: '#generateHTMLReportBtn',
                title: 'Interactive: Generate Your First Report',
                content: 'Click "HTML Report" to generate a professional vulnerability assessment report. This creates a comprehensive document suitable for clients, management, or compliance requirements.',
                action: 'pulse',
                position: 'left',
                interactive: true,
                interaction: {
                    type: 'click',
                    instructions: 'Click "HTML Report" to generate a report',
                    successMessage: 'Perfect! Your vulnerability report has been generated.',
                    autoAdvance: true,
                    advanceDelay: 2500
                }
            },
            {
                target: '#exportResultsBtn',
                title: 'Data Export Options',
                content: 'Export raw scan data for further analysis, integration with other security tools, or archival purposes. The exported JSON contains all technical details, timestamps, and evidence.',
                action: 'highlight',
                position: 'left'
            },
            {
                target: '#targetUrlInput',
                title: 'Custom Target Addition',
                content: 'For real-world usage, you can add custom targets by entering URLs here. Always ensure you have explicit permission to scan any target - unauthorized scanning is illegal and unethical.',
                action: 'highlight',
                position: 'right'
            },
            {
                target: '#vulnerability-scanner-container',
                title: 'Vulnerability Scanner Training Complete!',
                content: 'Congratulations! You\'ve mastered the Web Vulnerability Scanner. You learned to: select and configure targets, start comprehensive scans, monitor progress and results, analyze vulnerability findings, and generate professional reports. Use this knowledge responsibly to improve cybersecurity!',
                action: 'highlight',
                position: 'center',
                final: true
            }
        ];
    }

    async start() {
        // Ensure vulnerability scanner is open
        if (!this.desktop.windowManager.windows.has('vulnerability-scanner')) {
            try {
                await this.desktop.windowManager.openVulnerabilityScanner();
                // Wait for the window to fully render and UI to initialize
                await new Promise(resolve => setTimeout(resolve, 2000));
            } catch (error) {
                console.error('Vulnerability Scanner application not found:', error);
                return;
            }
        }

        // Initialize CSS first
        this.initializeCSS();
        
        // Enable tutorial mode
        tutorialInteractionManager.enableTutorialMode();
        
        // Set tutorial state
        this.isActive = true;
        this.stepManager.reset();
        
        // Create overlay before showing any steps
        this.createOverlay();
        
        // Ensure vulnerability scanner window is in front
        this.ensureVulnerabilityScannerInFront();
        
        // Set global reference
        window.vulnerabilityScannerTutorial = this;
        window.currentTutorial = this;
        
        // Wait for vulnerability scanner to be fully loaded and then start showing steps
        this.showStep();
    }

    ensureVulnerabilityScannerInFront() {
        const scannerWindow = document.querySelector('.window[data-window-id="vulnerability-scanner"]') || 
                             document.querySelector('.window .vulnerability-scanner') ||
                             document.querySelector('[id*="vulnerability-scanner"]')?.closest('.window');
        
        if (scannerWindow) {
            scannerWindow.style.zIndex = '51';
            scannerWindow.style.position = 'relative';
        }
    }

    showStep() {
        if (this.currentStep >= this.steps.length) {
            this.complete();
            return;
        }

        const step = this.steps[this.currentStep];
        let target = document.querySelector(step.target);
        
        // Special handling for target selection step
        if (step.target === '#targetSelect') {
            const select = document.querySelector('#targetSelect');
            if (select && select.options.length <= 1) {
                // If dropdown is empty, wait for targets to load
                setTimeout(() => {
                    this.showStep();
                }, 500);
                return;
            }
            target = select;
        }

        // Special handling for scan progress bar - ensure it's visible during scan
        if (step.target === '#progressBar') {
            const progressContainer = document.querySelector('#progressBar')?.closest('.progress-panel');
            if (progressContainer) {
                progressContainer.style.display = 'block';
            }
            target = document.querySelector('#progressBar');
        }

        // Special handling for vulnerability results - ensure there's content or show placeholder
        if (step.target === '#vulnerabilitiesContainer') {
            const container = document.querySelector('#vulnerabilitiesContainer');
            if (container && container.children.length === 1) {
                // If only showing placeholder, ensure it's visible
                const placeholder = container.querySelector('.text-center');
                if (placeholder) {
                    placeholder.style.display = 'block';
                }
            }
            target = container;
        }

        // Special handling for report buttons - ensure they're enabled for tutorial
        if (step.target === '#generateHTMLReportBtn') {
            const reportBtn = document.querySelector('#generateHTMLReportBtn');
            if (reportBtn && reportBtn.disabled) {
                // Temporarily enable for tutorial demonstration
                reportBtn.disabled = false;
                reportBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                reportBtn.style.pointerEvents = 'auto';
            }
            target = reportBtn;
        }
        
        if (!target) {
            console.warn(`Tutorial target not found: ${step.target}`);
            // Try to continue with next step after a delay
            setTimeout(() => {
                this.nextStep();
            }, 1000);
            return;
        }

        // Clear previous highlights and interactions
        this.clearHighlights();
        this.clearStepInteractions();
        
        // Highlight target element
        this.highlightElement(target, step.action);
        
        // Setup interactions for this step
        this.setupStepInteraction(step, target);
        
        // Position and show tooltip
        this.showTooltip(target, step);
    }

    setupStepInteraction(step, target) {
        // Call parent method first
        super.setupStepInteraction(step, target);

        // Special handling for vulnerability scanner interactions
        if (step.interactive && step.interaction) {
            // Make sure the target is clickable during tutorial
            target.style.pointerEvents = 'auto';
            target.style.cursor = 'pointer';
            
            // Allow interaction with tutorial elements
            tutorialInteractionManager.allowInteractionFor(target);

            // For select interactions, also allow interaction with options
            if (step.interaction.type === 'select') {
                const options = target.querySelectorAll('option');
                options.forEach(option => {
                    tutorialInteractionManager.allowInteractionFor(option);
                });
            }
        }
    }

    complete() {
        super.complete();
        
        // Store completion in localStorage
        localStorage.setItem('cyberquest_vulnerabilityscanner_tutorial_completed', 'true');
        
        // Reset any temporary changes made for tutorial
        const reportBtn = document.querySelector('#generateHTMLReportBtn');
        if (reportBtn) {
            // Reset report button state if it was modified for tutorial
            const scannerApp = document.querySelector('#vulnerability-scanner-container')?._vulnerabilityApp;
            if (scannerApp && scannerApp.ui && scannerApp.ui.uiRenderer) {
                scannerApp.ui.uiRenderer.updateReportButtonsAvailability();
            }
        }
    }

    // Override base class methods for proper tutorial flow
    getSkipTutorialHandler() {
        return 'window.vulnerabilityScannerTutorial.showSkipModal()';
    }

    getPreviousStepHandler() {
        return 'window.vulnerabilityScannerTutorial.previousStep()';
    }

    getNextStepHandler() {
        return 'window.vulnerabilityScannerTutorial.nextStep()';
    }

    getFinalStepHandler() {
        return 'window.vulnerabilityScannerTutorial.complete()';
    }

    getFinalButtonText() {
        return 'Complete Vulnerability Scanner Training';
    }

    // Enhanced CSS for vulnerability scanner tutorial
    initializeCSS() {
        super.initializeCSS();
        
        // Add vulnerability scanner specific styles
        const scannerStyles = document.createElement('style');
        scannerStyles.innerHTML = `
            .vulnerability-scanner-tutorial-highlight {
                border: 2px solid #3b82f6 !important;
                box-shadow: 0 0 20px rgba(59, 130, 246, 0.5) !important;
                background: rgba(59, 130, 246, 0.1) !important;
            }
            
            .vulnerability-scanner-tutorial-pulse {
                animation: vulnerability-scanner-pulse 2s infinite;
            }
            
            @keyframes vulnerability-scanner-pulse {
                0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
                70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
                100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
            }
            
            .tutorial-highlight .tab-btn {
                z-index: 52 !important;
                position: relative !important;
            }
            
            .tutorial-highlight .btn,
            .tutorial-highlight button {
                z-index: 52 !important;
                position: relative !important;
            }
        `;
        document.head.appendChild(scannerStyles);
    }

    // Static methods for auto-start functionality
    static shouldAutoStart() {
        const tutorialCompleted = localStorage.getItem('cyberquest_vulnerabilityscanner_tutorial_completed');
        const scannerOpened = localStorage.getItem('cyberquest_vulnerabilityscanner_opened');
        
        return scannerOpened && !tutorialCompleted;
    }

    static startTutorial(desktop) {
        console.log('Starting Vulnerability Scanner tutorial...');
        const tutorial = new VulnerabilityScannerTutorial(desktop);
        window.vulnerabilityScannerTutorial = tutorial;
        tutorial.start();
        return tutorial;
    }

    static restart() {
        localStorage.removeItem('cyberquest_vulnerabilityscanner_tutorial_completed');
        localStorage.removeItem('cyberquest_vulnerabilityscanner_opened');
        
        if (window.vulnerabilityScannerTutorial) {
            window.vulnerabilityScannerTutorial.cleanup();
        }
    }
}
